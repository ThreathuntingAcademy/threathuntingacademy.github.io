
# 1. Bypassing Microsoft Defender for Endpoint (MDE) with 9 year old UAC bypass technique (FODHelper.exe)

## FOREWORD

When I started building the ***Threathunting Academy Evasion*** course, i spend quite a lot of time researchiing how MDA and MDE detection actiallu works, and how to bypass it.

How exactly to they detect a malicious payload? How much of it is signatures, how much of it is heuristics, how much of it is machine learning? What are the main features they look at? How do they detect obfuscated payloads? How do they detect in-memory payloads?

As we deal with `privilege escalation` in that course, I wanted to cover the FOD (Feature on Demand) images technique, which is a well-known UAC bypass technique that has been around for a while, but is still effective and widely used by attackers, however it gets detected by MDA and MDE, so I wanted to show how the detection works and how to bypass it.

## 1.1 WHAT IS UAC?

- **User Account Control (UAC)** is a security feature in Windows that helps prevent unauthorized changes to the operating system.
- It prompts users for permission or an administrator password before allowing actions that could potentially affect the system.
- UAC helps mitigate the impact of malware and unauthorized software by limiting the privileges of applications and users.  

It basically ensures that even if a user is logged in with administrative privileges, applications they run do not automatically have those privileges, reducing the risk of malicious software gaining full control of the system. His interity level is set to ***medium***, which means it can run with standard user privileges, but not with administrative privileges.

> ***Note:*** UAC is not a security boundary, it is a user interface boundary, it can be bypassed by attackers to gain elevated privileges without user interaction.

Obviously, attackers like to have high privileges on the system, as it allows them perfrm more post exploitation (e.g. installing services, scheduled tasks, reading credential from memory, installing driver...) and have more control over the system, so they often look for ways to bypass UAC and execute their payloads with elevated privileges.

## 1.2 Enter FodHelper.exe

Fodhelper can actually execute with elevated privileges without triggering a UAC prompt. This is because it is a trusted Windows component that is allowed to run with elevated privileges by default.

So you basically get proxy execution of your payload with elevated privileges without any user interaction. This is a common technique used by attackers to bypass UAC and execute malicious code with elevated privileges.

## 1.3 How to use FODHelper.exe for UAC Bypass?

The FodHelper UAC bypass was first publicly disclosed in 2017 ([GitHub](https://github.com/winscripting/UAC-bypass)) and has been used in various attack scenarios since then. To use FodHelper.exe for UAC bypass, you can follow these steps:

1. Create a registry key at `HKEY_CURRENT_USER\Software\Classes\ms-settings\shell\open\command`
2. Set the default value of this key to the path of your payload (e.g., `C:\path\to\your\payload.exe`)
3. Set the `DelegateExecute` value to an empty string
4. Run `fodhelper.exe` from the command line or by double-clicking it in the File Explorer

When you run `fodhelper.exe`, it will look for the registry key you created and execute the payload specified in the default value with elevated privileges, bypassing UAC.

INSERT YOUTUBE VIDEO HERE (https://www.youtube.com/watch?v=Zt2n9s8Xo5I)

Microsoft typically doesn't patch this vulnerability because it is a design flaw in how Windows handles certain trusted components and their interactions with the registry. However, both **Microsoft Defender Antivirus (MDA)** and **Microsoft Defender for Endpoint (MDE)** detect this technique so let's see how the detection works and how we can bypass it.

### 1.3.1 MDA : Detection and bypass of FODHelper.exe UAC Bypass (powershell vs. MDA)



### 1.3.1 MDE : Detection and bypass of FODHelper.exe UAC Bypass 

**Adding an new detection rule to MDE** - by looking for that registry and checking if the data contains `.exe` is a good way to detect this technique, but it is also a very generic rule that can easily be bypassed by attackers by simply obfuscating the payload path (e.g., using environment variables, using a different file extension, using a network path, etc.) or by using a different technique for UAC bypass.

## Bottom Line

This article shows how to think as an attacker and understand the detection mechanisms of security solutions like MDA and MDE, and how to bypass them. It also highlights the importance of understanding the underlying techniques and not just relying on tools, as well as the need for continuous learning and adaptation in the field of cybersecurity.

Augmenting your detection capabilities with a deep understanding of attack techniques and how to bypass them is crucial for effective threat hunting and incident response. By learning how attackers operate and how to evade detection, you can better protect your organization and stay one step ahead of potential threats.

This is exactly what we cover in the ***Threathunting Academy Evasion*** course, where we go deep into the techniques and tools used by attackers, and how to analyze and respond to them.

`Don't ASSUME that a technique is detected just because it is well-known, always test it yourself and understand how the detection works and how to bypass it.`